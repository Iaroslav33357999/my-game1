<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Neon&Talk | CYBERPUNK EDITION</title>
    <style>
        :root { 
            --neon: #00d9ff; --neon-glow: rgba(0, 217, 255, 0.7);
            --pink: #ff00ff; --pink-glow: rgba(255, 0, 255, 0.7);
            --green: #00ff88; --green-glow: rgba(0, 255, 136, 0.7);
            --orange: #ffaa00; --orange-glow: rgba(255, 170, 0, 0.7);
            --purple: #9d00ff; --purple-glow: rgba(157, 0, 255, 0.7);
            --yellow: #ffcc00; --yellow-glow: rgba(255, 204, 0, 0.7);
            --sys: var(--yellow);
            --red: #ff4444; --red-glow: rgba(255, 68, 68, 0.7);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            overflow: hidden; background: #000; 
            font-family: 'Segoe UI', 'Arial', 'Courier New', monospace; color: white;
            height: 100vh;
        }
        
        #crt-overlay {
            position: fixed; inset: 0; pointer-events: none; z-index: 9999;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
            background-size: 100% 4px; opacity: 0.3;
        }
        
        /* –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ü–ï–†–ï–ó–ê–ü–£–°–ö–ê */
        #respawn-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(10px);
            animation: modalFadeIn 0.5s ease-out;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: linear-gradient(135deg, #0a0a1a, #000022);
            border: 3px solid var(--red);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            box-shadow: 0 0 50px var(--red-glow),
                        inset 0 0 30px rgba(255, 68, 68, 0.1);
            animation: modalPulse 2s infinite alternate;
        }
        
        @keyframes modalPulse {
            0% { box-shadow: 0 0 50px var(--red-glow), inset 0 0 30px rgba(255, 68, 68, 0.1); }
            100% { box-shadow: 0 0 70px var(--red-glow), inset 0 0 40px rgba(255, 68, 68, 0.2); }
        }
        
        .modal-header {
            color: var(--red);
            font-size: 32px;
            margin-bottom: 20px;
            text-shadow: 0 0 20px var(--red);
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .modal-message {
            color: #fff;
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 30px;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
        }
        
        .modal-timer {
            color: var(--neon);
            font-size: 48px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            margin: 30px 0;
            text-shadow: 0 0 20px var(--neon);
            animation: timerPulse 1s infinite;
        }
        
        @keyframes timerPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .modal-subtext {
            color: #aaa;
            font-size: 14px;
            margin-top: 20px;
            font-style: italic;
        }
        
        #menu { 
            position: absolute; inset: 0; 
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(157, 0, 255, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(0, 217, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at center, #0a0a1a 0%, #000 100%); 
            display: flex; flex-direction: column; align-items: center; 
            z-index: 5000; text-align: center;
            animation: bgPulse 8s infinite alternate;
            overflow-y: auto;
            padding: 20px 20px 40px 20px;
        }
        @keyframes bgPulse {
            0% { background-color: #050510; }
            100% { background-color: #0a0a25; }
        }
        
        .control-box { 
            background: rgba(0, 0, 0, 0.7); border: 2px solid var(--neon); 
            padding: 25px; border-radius: 15px; margin-bottom: 20px; 
            width: 90%; max-width: 800px;
            box-shadow: 0 0 30px var(--neon-glow), inset 0 0 20px rgba(0, 217, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        .control-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; text-align: left; font-size: 16px; }
        .key-hint { color: var(--neon); font-weight: bold; white-space: nowrap; text-shadow: 0 0 10px var(--neon); }

        input#nickInput { 
            background: rgba(0, 0, 0, 0.8); border: 2px solid var(--neon); color: white; 
            padding: 15px; width: 90%; max-width: 400px; text-align: center; 
            font-size: 18px; outline: none; border-radius: 10px; margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
            transition: all 0.3s;
        }
        input#nickInput:focus { box-shadow: 0 0 30px var(--neon-glow); border-color: var(--pink); }
        
        button#startBtn { 
            padding: 18px 60px; background: linear-gradient(45deg, var(--neon), var(--purple)); 
            border: none; cursor: pointer; font-weight: bold; font-size: 22px; border-radius: 10px;
            color: black; text-transform: uppercase; letter-spacing: 2px;
            transition: all 0.3s; box-shadow: 0 0 25px rgba(0, 217, 255, 0.5);
            position: relative; overflow: hidden;
            margin: 10px 0 30px 0;
            min-width: 300px;
        }
        button#startBtn:hover { transform: scale(1.05); box-shadow: 0 0 35px var(--neon-glow); }
        button#startBtn::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg); animation: shine 3s infinite;
        }
        @keyframes shine { 0% { transform: translateX(-100%) rotate(45deg); } 100% { transform: translateX(100%) rotate(45deg); } }

        #story-box {
            background: rgba(0, 0, 0, 0.7); border: 2px solid var(--pink);
            padding: 20px; border-radius: 15px; margin-bottom: 20px; 
            width: 90%; max-width: 800px;
            box-shadow: 0 0 30px var(--pink-glow);
            backdrop-filter: blur(10px);
        }
        
        #story-box h2 {
            color: var(--pink); margin-bottom: 15px; text-shadow: 0 0 10px var(--pink);
            font-family: 'Courier New', monospace; font-size: 22px;
        }
        
        #story-box p {
            color: #ccc; line-height: 1.6; margin-bottom: 10px;
            font-size: 16px;
        }
        
        #tutorial-box {
            background: rgba(0, 0, 0, 0.7); border: 2px solid var(--green);
            padding: 20px; border-radius: 15px; margin-bottom: 20px; 
            width: 90%; max-width: 800px;
            box-shadow: 0 0 30px var(--green-glow);
            backdrop-filter: blur(10px);
        }
        
        #tutorial-box h2 {
            color: var(--green); margin-bottom: 15px; text-shadow: 0 0 10px var(--green);
            font-family: 'Courier New', monospace; font-size: 22px;
        }
        
        .tutorial-item {
            background: rgba(0, 255, 136, 0.1); border-left: 4px solid var(--green);
            padding: 12px 15px; margin-bottom: 10px; border-radius: 0 8px 8px 0;
            font-size: 15px;
        }
        
        .tutorial-item b {
            color: var(--green);
        }
        
        #ui-wrapper { 
            position: absolute; bottom: 25px; left: 25px; display: flex; flex-direction: column; gap: 15px; z-index: 1000; 
            width: 420px;
        }
        
        #respawn-btn {
            background: linear-gradient(45deg, var(--red), var(--orange));
            color: white; border: none; padding: 12px 25px; font-weight: bold; 
            cursor: pointer; border-radius: 8px; font-size: 14px; width: max-content; 
            white-space: nowrap; box-shadow: 0 0 15px var(--red-glow); transition: all 0.3s;
            display: flex; align-items: center; gap: 8px;
        }
        #respawn-btn:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 0 25px var(--red-glow); }
        #respawn-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        #lockBtn { 
            background: linear-gradient(45deg, var(--neon), var(--green)); color: black; border: none; 
            padding: 12px 25px; font-weight: bold; cursor: pointer; border-radius: 8px; font-size: 14px;
            width: max-content; white-space: nowrap; box-shadow: 0 0 15px var(--neon-glow);
            transition: all 0.3s;
        }
        #lockBtn:hover { transform: scale(1.05); box-shadow: 0 0 25px var(--neon-glow); }

        #chat-container { 
            width: 100%; height: 250px; background: rgba(0, 0, 0, 0.85); 
            display: flex; flex-direction: column; border: 1px solid var(--neon); border-radius: 10px;
            backdrop-filter: blur(5px); box-shadow: 0 0 20px rgba(0, 217, 255, 0.2);
        }
        #chat-messages { flex: 1; overflow-y: auto; padding: 15px; font-size: 14px; word-break: break-word; }
        #chat-input { 
            background: rgba(0, 0, 0, 0.8); border: none; color: white; padding: 15px; 
            outline: none; border-top: 1px solid var(--neon); 
            font-family: 'Courier New', monospace;
        }

        #tab-menu, #music-menu, #settings-menu { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 500px; max-width: 90vw; background: rgba(5, 5, 30, 0.95); border: 3px solid var(--neon); 
            border-radius: 15px; display: none; z-index: 10000; overflow: hidden;
            box-shadow: 0 0 60px var(--neon-glow);
            backdrop-filter: blur(10px);
        }
        .tab-header { 
            background: linear-gradient(90deg, var(--neon), var(--purple)); 
            color: black; padding: 15px; font-weight: bold; text-align: center; font-size: 20px;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        .tab-row { 
            display: flex; justify-content: space-between; padding: 12px 20px; 
            border-bottom: 1px solid rgba(0, 217, 255, 0.2); font-size: 16px;
            transition: all 0.3s;
        }
        .tab-row:hover { background: rgba(0, 217, 255, 0.1); color: var(--neon); }
        
        #music-list { max-height: 400px; overflow-y: auto; }
        .music-item { 
            padding: 12px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center;
            font-size: 15px;
        }
        .music-item:hover { background: rgba(0, 217, 255, 0.15); color: var(--neon); }
        .music-item.active { 
            border-left: 5px solid var(--neon); background: rgba(0, 217, 255, 0.25); 
            color: var(--neon); text-shadow: 0 0 10px var(--neon);
        }
        .music-status { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }

        #bars-container {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; gap: 8px; width: 350px; max-width: 80vw;
            z-index: 900;
        }
        .bar-bg { 
            width: 100%; height: 12px; background: rgba(0, 0, 0, 0.6); 
            border-radius: 6px; overflow: hidden; position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        .bar-label { 
            position: absolute; left: 10px; top: -2px; font-size: 10px; 
            font-weight: bold; color: rgba(255,255,255,0.7); z-index: 2;
            font-family: 'Courier New', monospace; text-transform: uppercase;
        }
        
        #stamina-bar { 
            height: 100%; background: linear-gradient(90deg, var(--green), var(--neon)); 
            width: 100%; transition: width 0.2s; box-shadow: 0 0 10px var(--green-glow);
        }
        #fuel-bar { 
            height: 100%; background: linear-gradient(90deg, var(--orange), var(--pink)); 
            width: 100%; transition: width 0.2s; box-shadow: 0 0 10px var(--orange-glow);
        }

        #voice-ui { 
            position: absolute; top: 30px; right: 30px; color: var(--green); 
            display: none; font-weight: bold; text-shadow: 0 0 10px var(--green);
            font-family: 'Courier New', monospace; padding: 5px 10px;
            background: rgba(0, 0, 0, 0.5); border-radius: 5px; border: 1px solid var(--green);
        }
        #fly-ui { 
            position: absolute; top: 60px; right: 30px; color: var(--pink); 
            display: none; font-weight: bold; text-shadow: 0 0 10px var(--pink);
            font-family: 'Courier New', monospace; padding: 5px 10px;
            background: rgba(0, 0, 0, 0.5); border-radius: 5px; border: 1px solid var(--pink);
        }
        .msg-line { margin-bottom: 4px; padding: 2px 0; }

        #volume-container {
            position: absolute; bottom: 25px; right: 25px;
            background: rgba(0, 0, 0, 0.7); padding: 10px 15px; border-radius: 8px;
            border: 1px solid var(--neon); display: none; align-items: center; gap: 10px;
            z-index: 1001; backdrop-filter: blur(5px);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.2);
        }
        #volume-container label { 
            font-size: 12px; color: var(--neon); font-weight: bold; 
            font-family: 'Courier New', monospace;
        }
        input[type=range] { 
            cursor: pointer; accent-color: var(--neon); width: 100px;
            filter: drop-shadow(0 0 5px var(--neon));
        }

        #now-playing-box {
            position: absolute; top: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8); border: 1px solid var(--neon);
            padding: 10px 25px; border-radius: 25px; font-size: 12px;
            color: var(--neon); z-index: 900; display: none;
            box-shadow: 0 0 25px var(--neon-glow);
            backdrop-filter: blur(5px); font-family: 'Courier New', monospace;
            text-shadow: 0 0 10px var(--neon);
        }
        
        #fps-counter {
            position: absolute; top: 30px; left: 30px; color: var(--green);
            font-family: 'Courier New', monospace; font-size: 12px;
            background: rgba(0, 0, 0, 0.5); padding: 5px 10px; border-radius: 5px;
            border: 1px solid var(--green); display: none;
        }
        
        .game-title {
            color: var(--neon); 
            font-size: clamp(42px, 8vw, 68px);
            margin: 20px 0 10px 0; 
            text-shadow: 0 0 30px var(--neon), 0 0 60px var(--purple);
            font-family: 'Courier New', monospace;
            letter-spacing: 3px;
            animation: titleGlow 2s infinite alternate;
        }
        @keyframes titleGlow {
            0% { text-shadow: 0 0 30px var(--neon), 0 0 60px var(--purple); }
            100% { text-shadow: 0 0 40px var(--neon), 0 0 80px var(--purple); }
        }
        
        .game-subtitle {
            color: var(--pink); margin-bottom: 20px; 
            text-shadow: 0 0 20px var(--pink); 
            font-size: clamp(16px, 3vw, 22px);
        }
        
        .start-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-top: 10px;
        }
        
        #made-by {
            position: absolute;
            bottom: 20px;
            right: 20px;
            color: var(--orange);
            font-size: 11px;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 10px var(--orange-glow);
            opacity: 0.7;
            z-index: 100;
            pointer-events: none;
        }
        
        #made-by-menu {
            position: absolute;
            bottom: 15px;
            right: 15px;
            color: var(--orange);
            font-size: 12px;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 10px var(--orange-glow);
            opacity: 0.8;
            z-index: 5001;
            pointer-events: none;
        }
        
        /* –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –î–û–ë–ê–í–õ–ï–ù–ù–´–• –≠–õ–ï–ú–ï–ù–¢–û–í */
        
        #distance-counter {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid var(--purple);
            border-radius: 25px;
            padding: 10px 25px;
            font-size: 14px;
            color: var(--purple);
            z-index: 900;
            backdrop-filter: blur(5px);
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 10px var(--purple);
            box-shadow: 0 0 20px rgba(157, 0, 255, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 220px;
            justify-content: center;
        }
        
        #distance-icon {
            font-size: 16px;
        }
        
        #distance-value {
            font-weight: bold;
            font-size: 18px;
        }
        
        #settings-btn {
            position: absolute;
            top: 30px;
            right: 30px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid var(--orange);
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: none;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }
        
        #settings-btn:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 0 20px var(--orange-glow);
            background: rgba(255, 170, 0, 0.1);
        }
        
        .settings-item {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .settings-item label {
            color: var(--neon);
            font-size: 15px;
            font-family: 'Courier New', monospace;
        }
        
        .settings-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        select.settings-select {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--neon);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            min-width: 120px;
        }
        
        .item-pickup {
            position: absolute;
            font-size: 24px;
            animation: pickupFloat 1s ease-out forwards;
            pointer-events: none;
            z-index: 1000;
        }
        
        @keyframes pickupFloat {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(0.5); opacity: 0; }
        }
        
        .platform-moving {
            animation: platformMove 3s infinite alternate ease-in-out;
        }
        
        .platform-rotating {
            animation: platformRotate 10s infinite linear;
        }
        
        @keyframes platformMove {
            0% { transform: translateY(0); }
            100% { transform: translateY(10px); }
        }
        
        @keyframes platformRotate {
            0% { transform: rotateY(0); }
            100% { transform: rotateY(360deg); }
        }
        
        @media (max-height: 800px) {
            .game-title { font-size: clamp(36px, 6vw, 48px); margin: 10px 0; }
            .game-subtitle { margin-bottom: 15px; font-size: clamp(14px, 2.5vw, 18px); }
            .control-box { padding: 20px; margin-bottom: 15px; }
            #story-box, #tutorial-box { padding: 15px; margin-bottom: 15px; }
            .tutorial-item { padding: 10px 12px; font-size: 14px; }
            .control-grid { gap: 10px; font-size: 15px; }
            button#startBtn { padding: 15px 40px; font-size: 20px; margin: 5px 0 20px 0; }
            #made-by { bottom: 10px; right: 10px; font-size: 10px; }
            #made-by-menu { bottom: 8px; right: 8px; font-size: 10px; }
            #distance-counter { bottom: 80px; padding: 8px 20px; font-size: 13px; min-width: 200px; }
        }
    </style>
</head>
<body>
    <div id="crt-overlay"></div>
    
    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ü–ï–†–ï–ó–ê–ü–£–°–ö–ê -->
    <div id="respawn-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>‚ö†Ô∏è</span>
                <span>–ü–ï–†–ï–ó–ê–ü–£–°–ö –°–ò–°–¢–ï–ú–´</span>
                <span>‚ö†Ô∏è</span>
            </div>
            
            <div class="modal-message">
                <p>üîπ <strong>–í–ù–ò–ú–ê–ù–ò–ï!</strong> –í—ã –Ω–∞–∂–∞–ª–∏ –∫–Ω–æ–ø–∫—É —Ä–µ—Å–ø–∞–≤–Ω–∞!</p>
                <p>üîπ –°–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏–≥—Ä–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞.</p>
                <p>üîπ –í—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –±—É–¥—É—Ç —Ä–∞–∑–æ—Ä–≤–∞–Ω—ã, –º–∏—Ä –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω.</p>
                <p>üîπ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑:</p>
            </div>
            
            <div class="modal-timer" id="respawn-timer">10</div>
            
            <div class="modal-subtext">
                –ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–µ—Å–ø–∞–≤–Ω–∞.
            </div>
        </div>
    </div>
    
    <div id="made-by">Made by YANFUN TEAM</div>
    <audio id="bgMusic" src="" loop></audio>

    <!-- –ù–û–í–´–ô –≠–õ–ï–ú–ï–ù–¢: –°–ß–ï–¢–ß–ò–ö –î–ò–°–¢–ê–ù–¶–ò–ò -->
    <div id="distance-counter">
        <span id="distance-icon">üìç</span>
        <span>–ü—Ä–æ–π–¥–µ–Ω–æ –æ—Ç —Å–ø–∞–≤–Ω–∞:</span>
        <span id="distance-value">0 –º</span>
    </div>

    <!-- –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê: –ù–ê–°–¢–†–û–ô–ö–ò –ì–†–ê–§–ò–ö–ò -->
    <div id="settings-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∏">
        ‚öôÔ∏è
    </div>

    <div id="now-playing-box">üéµ –°–ï–ô–ß–ê–° –ò–ì–†–ê–ï–¢: <span id="track-name">---</span></div>
    <div id="voice-ui">üé§ –ú–ò–ö–†–û–§–û–ù –ê–ö–¢–ò–í–ï–ù</div>
    <div id="fly-ui">üöÄ –†–ï–ñ–ò–ú –ü–û–õ–ï–¢–ê –ê–ö–¢–ò–í–ï–ù</div>
    <div id="fps-counter">FPS: 0</div>
    
    <div id="tab-menu">
        <div class="tab-header">–ê–ö–¢–ò–í–ù–´–ï –°–û–ï–î–ò–ù–ï–ù–ò–Ø</div>
        <div id="tab-list"></div>
    </div>

    <div id="music-menu">
        <div class="tab-header">–ö–ò–ë–ï–†–ü–ê–ù–ö –ü–õ–ï–ô–õ–ò–°–¢ (P)</div>
        <div id="music-list"></div>
    </div>

    <!-- –ù–û–í–û–ï –ú–ï–ù–Æ: –ù–ê–°–¢–†–û–ô–ö–ò –ì–†–ê–§–ò–ö–ò -->
    <div id="settings-menu">
        <div class="tab-header">–ù–ê–°–¢–†–û–ô–ö–ò –ì–†–ê–§–ò–ö–ò ‚öôÔ∏è</div>
        <div id="settings-content">
            <div class="settings-item">
                <label>–ö–∞—á–µ—Å—Ç–≤–æ –≥—Ä–∞—Ñ–∏–∫–∏:</label>
                <div class="settings-control">
                    <select id="graphics-quality" class="settings-select">
                        <option value="low">–ù–∏–∑–∫–æ–µ</option>
                        <option value="medium" selected>–°—Ä–µ–¥–Ω–µ–µ</option>
                        <option value="high">–í—ã—Å–æ–∫–æ–µ</option>
                        <option value="ultra">–£–ª—å—Ç—Ä–∞</option>
                    </select>
                </div>
            </div>
            <div class="settings-item">
                <label>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ FPS:</label>
                <div class="settings-control">
                    <select id="fps-limit" class="settings-select">
                        <option value="30">30 FPS</option>
                        <option value="60" selected>60 FPS</option>
                        <option value="120">120 FPS</option>
                        <option value="240">240 FPS</option>
                        <option value="0">–ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è</option>
                    </select>
                </div>
            </div>
            <div class="settings-item">
                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–µ–∑–¥:</label>
                <div class="settings-control">
                    <select id="stars-count" class="settings-select">
                        <option value="1000">–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ</option>
                        <option value="5000" selected>–°—Ä–µ–¥–Ω–µ–µ</option>
                        <option value="15000">–í—ã—Å–æ–∫–æ–µ</option>
                        <option value="30000">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ</option>
                    </select>
                </div>
            </div>
            <div class="settings-item">
                <label>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –º–∏—Ä–∞:</label>
                <div class="settings-control">
                    <select id="world-detail" class="settings-select">
                        <option value="low">–ù–∏–∑–∫–∞—è</option>
                        <option value="medium" selected>–°—Ä–µ–¥–Ω—è—è</option>
                        <option value="high">–í—ã—Å–æ–∫–∞—è</option>
                    </select>
                </div>
            </div>
            <div class="settings-item">
                <label>–¢–µ–Ω–∏:</label>
                <div class="settings-control">
                    <select id="shadows" class="settings-select">
                        <option value="off">–í—ã–∫–ª—é—á–µ–Ω—ã</option>
                        <option value="low">–ù–∏–∑–∫–∏–µ</option>
                        <option value="high" selected>–í—ã—Å–æ–∫–∏–µ</option>
                    </select>
                </div>
            </div>
            <div class="settings-item">
                <label>–≠—Ñ—Ñ–µ–∫—Ç—ã —á–∞—Å—Ç–∏—Ü:</label>
                <div class="settings-control">
                    <select id="particles" class="settings-select">
                        <option value="off">–í—ã–∫–ª—é—á–µ–Ω—ã</option>
                        <option value="low" selected>–ù–∏–∑–∫–∏–µ</option>
                        <option value="high">–í—ã—Å–æ–∫–∏–µ</option>
                    </select>
                </div>
            </div>
            <div class="settings-item" style="justify-content: center; padding: 20px;">
                <button id="apply-settings" style="
                    padding: 10px 30px;
                    background: linear-gradient(45deg, var(--neon), var(--green));
                    border: none;
                    border-radius: 8px;
                    color: black;
                    font-weight: bold;
                    cursor: pointer;
                    font-family: 'Courier New', monospace;
                ">–ü–†–ò–ú–ï–ù–ò–¢–¨</button>
            </div>
        </div>
    </div>

    <div id="menu">
        <h1 class="game-title">NEON&TALK</h1>
        <h2 class="game-subtitle">CYBERPUNK EDITION v2.0</h2>
        
        <div id="story-box">
            <h2>üìñ –û–ë–ù–û–í–õ–ï–ù–ò–ï 2.0 - –ù–û–í–´–ï –í–û–ó–ú–û–ñ–ù–û–°–¢–ò</h2>
            <p>üîπ <b>–ë–ï–°–ö–û–ù–ï–ß–ù–´–ô –ú–ò–†</b>: –¢–µ–ø–µ—Ä—å –º–∏—Ä –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ - –ª–µ—Ç–∞–π—Ç–µ —Å–∫–æ–ª—å–∫–æ —É–≥–æ–¥–Ω–æ!</p>
            <p>üîπ <b>–ü–ê–†–ö–£–† –ò –î–í–ò–ñ–£–©–ò–ï–°–Ø –ü–õ–ê–¢–§–û–†–ú–´</b>: –ù–æ–≤—ã–µ —Ç–∏–ø—ã –ø–ª–∞—Ç—Ñ–æ—Ä–º –¥–ª—è –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ –≥–µ–π–º–ø–ª–µ—è.</p>
            <p>üîπ <b>–°–ß–ï–¢–ß–ò–ö –î–ò–°–¢–ê–ù–¶–ò–ò</b>: –°–º–æ—Ç—Ä–∏—Ç–µ —Å–∫–æ–ª—å–∫–æ –º–µ—Ç—Ä–æ–≤ –≤—ã –ø—Ä–æ–ª–µ—Ç–µ–ª–∏ –æ—Ç —Å–ø–∞–≤–Ω–∞.</p>
            <p>üîπ <b>–ü–†–ï–î–ú–ï–¢–´ –£–õ–£–ß–®–ï–ù–ò–ô</b>: –°–æ–±–∏—Ä–∞–π—Ç–µ –±—É—Å—Ç—ã –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Å—Ç–∞–º–∏–Ω—ã –∏ —Ç–æ–ø–ª–∏–≤–∞.</p>
            <p>üîπ <b>–ù–ê–°–¢–†–û–ô–ö–ò –ì–†–ê–§–ò–ö–ò</b>: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∏–≥—Ä—É –ø–æ–¥ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–∞—à–µ–≥–æ –ü–ö.</p>
            <p>üîπ <b>–£–õ–£–ß–®–ï–ù–ù–ê–Ø –ì–ï–ù–ï–†–ê–¶–ò–Ø</b>: –ë–æ–ª—å—à–µ –∑–≤–µ–∑–¥, –±–æ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π, –ª—É—á—à–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è!</p>
        </div>
        
        <div id="tutorial-box">
            <h2>üéÆ –ö–ê–ö –ò–ì–†–ê–¢–¨ - –ë–´–°–¢–†–´–ô –°–¢–ê–†–¢</h2>
            
            <div class="tutorial-item">
                <b>üî• –ù–û–í–´–ï –≠–õ–ï–ú–ï–ù–¢–´:</b><br>
                ‚Ä¢ <span style="color:var(--purple)">–î–≤–∏–∂—É—â–∏–µ—Å—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã</span> - –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –∫–æ—Ç–æ—Ä—ã–µ –¥–≤–∏–≥–∞—é—Ç—Å—è –≤–≤–µ—Ä—Ö-–≤–Ω–∏–∑<br>
                ‚Ä¢ <span style="color:var(--orange)">–í—Ä–∞—â–∞—é—â–∏–µ—Å—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã</span> - –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –∫–æ—Ç–æ—Ä—ã–µ –≤—Ä–∞—â–∞—é—Ç—Å—è<br>
                ‚Ä¢ <span style="color:var(--green)">–ë—É—Å—Ç—ã —É–ª—É—á—à–µ–Ω–∏–π</span> - —Å–æ–±–∏—Ä–∞–π—Ç–µ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Å—Ç–∞–º–∏–Ω—ã –∏ —Ç–æ–ø–ª–∏–≤–∞<br>
                ‚Ä¢ <span style="color:var(--red)">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∏</span> - –∫–Ω–æ–ø–∫–∞ ‚öôÔ∏è –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É
            </div>
            
            <div class="tutorial-item">
                <b>üîß –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†:</b><br>
                ‚Ä¢ –í–≤–µ–¥–∏—Ç–µ –≤ —á–∞—Ç: <span style="color:var(--pink)">/login –ø–∞—Ä–æ–ª—å</span> - –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞<br>
                ‚Ä¢ –í–≤–µ–¥–∏—Ç–µ: <span style="color:var(--neon)">/help</span> - —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥<br>
                ‚Ä¢ <span style="color:var(--green)">/distance</span> - —Å–∫–æ–ª—å–∫–æ –º–µ—Ç—Ä–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ<br>
                ‚Ä¢ <span style="color:var(--orange)">/stats</span> - –≤–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É–ª—É—á—à–µ–Ω–∏–π
            </div>
            
            <div class="tutorial-item">
                <b>üìä –ù–û–í–´–ï –ö–û–ú–ê–ù–î–´:</b><br>
                ‚Ä¢ <span style="color:var(--green)">/distance</span> - –ø—Ä–æ–π–¥–µ–Ω–Ω–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è<br>
                ‚Ä¢ <span style="color:var(--orange)">/stats</span> - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É–ª—É—á—à–µ–Ω–∏–π<br>
                ‚Ä¢ <span style="color:var(--neon)">‚öôÔ∏è –ö–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫</span> - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∏<br>
                ‚Ä¢ <span style="color:var(--purple)">üìç –°—á–µ—Ç—á–∏–∫ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏</span> - –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞
            </div>
        </div>
        
        <div class="control-box">
            <div class="control-grid">
                <span>–î–≤–∏–∂–µ–Ω–∏–µ:</span> <span class="key-hint">W A S D</span>
                <span>–î–∂–µ—Ç–ø–∞–∫:</span> <span class="key-hint">SPACE (–ó–ê–ñ–ê–¢–¨)</span>
                <span>–ü–ª–µ–π–ª–∏—Å—Ç:</span> <span class="key-hint">–ö–õ–ê–í–ò–®–ê P</span>
                <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏:</span> <span class="key-hint">–ö–ù–û–ü–ö–ê ‚öôÔ∏è (—Å–ø—Ä–∞–≤–∞ —Å–≤–µ—Ä—Ö—É)</span>
                <span>–ß–∞—Ç:</span> <span class="key-hint">ENTER</span>
                <span>–ì–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç:</span> <span class="key-hint">–ó–ê–ñ–ê–¢–¨ V</span>
                <span>–°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤:</span> <span class="key-hint">TAB</span>
                <span>–†–µ—Å–ø–∞–≤–Ω:</span> <span class="key-hint">–ö–ù–û–ü–ö–ê "–†–ï–°–ü–ê–í–ù"</span>
                <span>–î–∏—Å—Ç–∞–Ω—Ü–∏—è:</span> <span class="key-hint">/distance –≤ —á–∞—Ç–µ</span>
                <span>–û—Å–≤–æ–±–æ–¥–∏—Ç—å –∫—É—Ä—Å–æ—Ä:</span> <span class="key-hint">ESC</span>
                <span>–°–±–æ—Ä –ø—Ä–µ–¥–º–µ—Ç–æ–≤:</span> <span class="key-hint">–ü–û–î–õ–ï–¢–ï–¢–¨ –ö –ù–ò–ú</span>
            </div>
        </div>
        
        <div class="start-container">
            <input type="text" id="nickInput" placeholder="–í–í–ï–î–ò–¢–ï –ù–ò–ö–ù–ï–ô–ú (–ú–ê–ö–° 14 –°–ò–ú–í.)" maxlength="14">
            <button id="startBtn">–ü–û–î–ö–õ–Æ–ß–ò–¢–¨–°–Ø –ö –°–ï–¢–ò</button>
        </div>
        
        <div id="made-by-menu">Made by YANFUN TEAM</div>
    </div>

    <div id="bars-container">
        <div class="bar-bg">
            <span class="bar-label">–í–´–ù–û–°–õ–ò–í–û–°–¢–¨</span>
            <div id="stamina-bar"></div>
        </div>
        <div class="bar-bg">
            <span class="bar-label">–¢–û–ü–õ–ò–í–û –î–ñ–ï–¢–ü–ê–ö–ê</span>
            <div id="fuel-bar"></div>
        </div>
    </div>

    <div id="ui-wrapper">
        <button id="respawn-btn">üîÑ –†–ï–°–ü–ê–í–ù</button>
        <button id="lockBtn">üéØ –ó–ê–•–í–ê–¢–ò–¢–¨ –ö–£–†–°–û–†</button>
        <div id="chat-container">
            <div id="chat-messages"></div>
            <input type="text" id="chat-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ /help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥...">
        </div>
    </div>

    <div id="volume-container">
        <label>–ì–†–û–ú–ö–û–°–¢–¨</label>
        <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.35">
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script type="importmap"> { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } } </script>
    <script type="module">
        import * as THREE from 'three';
        const socket = io();
        
        // UI —ç–ª–µ–º–µ–Ω—Ç—ã
        const chatInput = document.getElementById('chat-input');
        const lockBtn = document.getElementById('lockBtn');
        const respawnBtn = document.getElementById('respawn-btn');
        const flyUI = document.getElementById('fly-ui');
        const voiceUI = document.getElementById('voice-ui');
        const fpsCounter = document.getElementById('fps-counter');
        const bgMusic = document.getElementById('bgMusic');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeContainer = document.getElementById('volume-container');
        const musicMenu = document.getElementById('music-menu');
        const musicListUI = document.getElementById('music-list');
        const nowPlayingBox = document.getElementById('now-playing-box');
        const trackNameUI = document.getElementById('track-name');
        const menu = document.getElementById('menu');
        const madeBy = document.getElementById('made-by');
        
        // –ù–û–í–´–ï –≠–õ–ï–ú–ï–ù–¢–´
        const distanceCounter = document.getElementById('distance-counter');
        const distanceValue = document.getElementById('distance-value');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsMenu = document.getElementById('settings-menu');
        const graphicsQuality = document.getElementById('graphics-quality');
        const fpsLimit = document.getElementById('fps-limit');
        const starsCount = document.getElementById('stars-count');
        const worldDetail = document.getElementById('world-detail');
        const shadows = document.getElementById('shadows');
        const particles = document.getElementById('particles');
        const applySettings = document.getElementById('apply-settings');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ—Å–ø–∞–≤–Ω–∞
        const respawnModal = document.getElementById('respawn-modal');
        const respawnTimer = document.getElementById('respawn-timer');
        
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–∏—Ä–∞
        let WORLD_CONFIG = {
            PLATFORM_SPACING: 12,
            PLATFORM_WIDTH: 18,
            PLATFORM_DEPTH: 18,
            SPAWN_POSITION: { x: 0, y: 1.7, z: 0 },
            SPAWN_PLATFORM_POSITION: { x: 0, y: 0, z: 0 },
            GENERATION_DISTANCE: 150,
            MAX_PLATFORMS: 1000,
            WORLD_HEIGHT_LIMIT: -5000
        };

        // –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let isGaming = false, myNick = "–ù–û–í–´–ô", isAdminFly = false;
        const otherPlayers = {};
        const audioPlayers = {};
        const clock = new THREE.Clock();
        let frameCount = 0, lastTime = performance.now(), fps = 0;
        let targetFPS = 60;
        let lastFrameTime = 0;
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å—Ç–∞–º–∏–Ω—ã
        let stamina = 100;
        let staminaMax = 100;
        let jetpackFuel = 100;
        let fuelMax = 100;
        let isSprinting = false;
        let sprintCooldown = false;
        let canSprint = true;
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–µ—Å–ø–∞–≤–Ω–∞
        let respawnCooldown = false;
        let respawnCooldownEndTime = 0;
        let respawnCountdownInterval = null;

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–∏—Ä–∞
        let platforms = [];
        let worldGenerated = false;
        let lastGeneratedIndex = 0;
        const PLATFORM_COUNT = 1000; // –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        let particlesSystem;
        let distanceTraveled = 0;
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∏
        let graphicsSettings = {
            quality: 'medium',
            fpsLimit: 60,
            stars: 5000,
            worldDetail: 'medium',
            shadows: true,
            particles: true,
            shadowQuality: 'high'
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ localStorage
        function loadSettings() {
            const saved = localStorage.getItem('neontalk_settings');
            if (saved) {
                graphicsSettings = JSON.parse(saved);
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ UI
                graphicsQuality.value = graphicsSettings.quality;
                fpsLimit.value = graphicsSettings.fpsLimit;
                starsCount.value = graphicsSettings.stars;
                worldDetail.value = graphicsSettings.worldDetail;
                shadows.value = graphicsSettings.shadowQuality;
                particles.value = graphicsSettings.particles ? 'high' : 'off';
                
                targetFPS = parseInt(graphicsSettings.fpsLimit) || 60;
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ localStorage
        function saveSettings() {
            localStorage.setItem('neontalk_settings', JSON.stringify(graphicsSettings));
        }

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≥—Ä–∞—Ñ–∏–∫–∏
        function applyGraphicsSettings() {
            graphicsSettings.quality = graphicsQuality.value;
            graphicsSettings.fpsLimit = parseInt(fpsLimit.value);
            graphicsSettings.stars = parseInt(starsCount.value);
            graphicsSettings.worldDetail = worldDetail.value;
            graphicsSettings.shadowQuality = shadows.value;
            graphicsSettings.particles = particles.value !== 'off';
            
            targetFPS = graphicsSettings.fpsLimit || 60;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–Ω–¥–µ—Ä–µ—Ä
            updateRendererSettings();
            
            // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –∑–≤–µ–∑–¥—ã —Å –Ω–æ–≤—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
            if (stars) {
                initStars();
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            saveSettings();
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫
            settingsMenu.style.display = 'none';
            if (isGaming) requestLock();
            
            // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            if (isGaming) {
                const chatMessage = {
                    nick: '–°–ò–°–¢–ï–ú–ê',
                    msg: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!',
                    type: 'sys'
                };
                socket.emit('receiveMessage', chatMessage);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ä–µ–Ω–¥–µ—Ä–µ—Ä–∞
        function updateRendererSettings() {
            // –ö–∞—á–µ—Å—Ç–≤–æ –≥—Ä–∞—Ñ–∏–∫–∏
            switch(graphicsSettings.quality) {
                case 'low':
                    renderer.setPixelRatio(1);
                    renderer.shadowMap.enabled = false;
                    break;
                case 'medium':
                    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
                    renderer.shadowMap.enabled = true;
                    renderer.shadowMap.type = THREE.BasicShadowMap;
                    break;
                case 'high':
                    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                    renderer.shadowMap.enabled = true;
                    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                    break;
                case 'ultra':
                    renderer.setPixelRatio(window.devicePixelRatio);
                    renderer.shadowMap.enabled = true;
                    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                    break;
            }
            
            // –¢–µ–Ω–∏
            if (directionalLight) {
                directionalLight.castShadow = graphicsSettings.shadowQuality !== 'off';
                
                if (graphicsSettings.shadowQuality === 'low') {
                    directionalLight.shadow.mapSize.width = 512;
                    directionalLight.shadow.mapSize.height = 512;
                } else if (graphicsSettings.shadowQuality === 'high') {
                    directionalLight.shadow.mapSize.width = 2048;
                    directionalLight.shadow.mapSize.height = 2048;
                }
            }
        }

        // –§–ò–ö–°: –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –±—ã—Å—Ç—Ä–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è –ø—Ä–æ–±–µ–ª–∞
        let spacePressTime = 0;
        const SPACE_COOLDOWN = 300;

        // --- –°–ò–°–¢–ï–ú–ê –ü–ï–†–ï–ó–ê–ü–£–°–ö–ê –ü–†–ò –†–ï–°–ü–ê–í–ù–ï ---
        function showRespawnModal() {
            if (bgMusic) {
                bgMusic.pause();
                bgMusic.currentTime = 0;
            }
            
            if (audioCtx) {
                audioCtx.close();
            }
            
            socket.disconnect();
            
            respawnModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            let seconds = 10;
            respawnTimer.textContent = seconds;
            
            respawnCountdownInterval = setInterval(() => {
                seconds--;
                respawnTimer.textContent = seconds;
                
                if (seconds <= 3) {
                    respawnTimer.style.color = 'var(--red)';
                    respawnTimer.style.textShadow = '0 0 20px var(--red)';
                } else if (seconds <= 7) {
                    respawnTimer.style.color = 'var(--orange)';
                    respawnTimer.style.textShadow = '0 0 20px var(--orange)';
                }
                
                if (seconds <= 0) {
                    clearInterval(respawnCountdownInterval);
                    window.location.reload();
                }
            }, 1000);
        }

        // --- –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–û–ï –ó–í–ï–ó–î–ù–û–ï –ù–ï–ë–û ---
        function createStars(count = 5000) {
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∑–≤–µ–∑–¥—ã
            if (stars) {
                scene.remove(stars);
            }
            
            // –î–ª—è —Å–ª–∞–±—ã—Ö –ü–ö –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç—ã–µ —Å–ø—Ä–∞–π—Ç—ã
            if (count > 10000 && graphicsSettings.quality === 'low') {
                count = 3000;
            }
            
            const starGeometry = new THREE.BufferGeometry();
            const starMaterial = new THREE.PointsMaterial({
                size: 0.07,
                transparent: true,
                opacity: 0.9,
                vertexColors: true
            });
            
            const starVertices = [];
            const starColors = [];
            
            // –¶–≤–µ—Ç–∞ –∑–≤–µ–∑–¥
            const starColorsPalette = [
                0xFFFFFF, // –ë–µ–ª—ã–π
                0x00D9FF, // –ì–æ–ª—É–±–æ–π
                0xFFAA00, // –û—Ä–∞–Ω–∂–µ–≤—ã–π
                0xFF00FF, // –†–æ–∑–æ–≤—ã–π
                0x00FF88, // –ó–µ–ª–µ–Ω—ã–π
                0x9D00FF  // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π
            ];
            
            for (let i = 0; i < count; i++) {
                // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–≤–µ–∑–¥ –≤ —Å—Ñ–µ—Ä–µ
                const radius = 2000 + Math.random() * 3000;
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos((Math.random() * 2) - 1);
                
                const x = radius * Math.sin(phi) * Math.cos(theta);
                const y = radius * Math.sin(phi) * Math.sin(theta);
                const z = radius * Math.cos(phi);
                
                starVertices.push(x, y, z);
                
                // –°–ª—É—á–∞–π–Ω—ã–π —Ü–≤–µ—Ç –∑–≤–µ–∑–¥—ã
                const colorIndex = Math.floor(Math.random() * starColorsPalette.length);
                const color = new THREE.Color(starColorsPalette[colorIndex]);
                
                // –ù–µ–º–Ω–æ–≥–æ –≤–∞—Ä—å–∏—Ä—É–µ–º —è—Ä–∫–æ—Å—Ç—å
                const brightness = 0.7 + Math.random() * 0.3;
                color.multiplyScalar(brightness);
                
                starColors.push(color.r, color.g, color.b);
            }
            
            starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
            starGeometry.setAttribute('color', new THREE.Float32BufferAttribute(starColors, 3));
            
            stars = new THREE.Points(starGeometry, starMaterial);
            scene.add(stars);
            
            return stars;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
        function getPlatformType(index) {
            if (index === 0) return 'spawn';
            
            const seed = index * 12345 + 67890;
            const rand = (seed % 1000) / 1000;
            
            if (index < 10) return 'normal';
            
            if (rand < 0.5) return 'normal';
            if (rand < 0.65) return 'moving';
            if (rand < 0.75) return 'jump';
            if (rand < 0.85) return 'rotating';
            if (rand < 0.92) return 'narrow';
            return 'item';
        }

        // --- –£–õ–£–ß–®–ï–ù–ù–´–ï –ù–ï–û–ù–û–í–´–ï –ü–õ–ê–¢–§–û–†–ú–´ –° –ü–ê–†–ö–£–†–û–ú ---
        function createCyberPlatform(x, y, z, type = 'normal', index = 0) {
            const group = new THREE.Group();
            
            // –†–∞–∑–º–µ—Ä—ã –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            let width = WORLD_CONFIG.PLATFORM_WIDTH;
            let depth = WORLD_CONFIG.PLATFORM_DEPTH;
            
            if (type === 'narrow') {
                width = 8;
                depth = 8;
            } else if (type === 'jump') {
                width = 6;
                depth = 6;
            }
            
            // –¶–≤–µ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
            const colors = [0x00d9ff, 0xff00ff, 0x00ff88, 0xffaa00, 0x9d00ff];
            const color = colors[Math.floor(Math.random() * colors.length)];
            
            // –û—Å–Ω–æ–≤–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞
            const platformGeo = new THREE.BoxGeometry(width, 0.5, depth);
            const platformMat = new THREE.MeshStandardMaterial({
                color: 0x111111,
                emissive: color,
                emissiveIntensity: 0.3,
                metalness: 0.9,
                roughness: 0.1
            });
            const platform = new THREE.Mesh(platformGeo, platformMat);
            platform.position.set(0, 0, 0);
            group.add(platform);
            
            // –ù–µ–æ–Ω–æ–≤—ã–µ –ø–æ–ª–æ—Å—ã –ø–æ –∫—Ä–∞—è–º
            const edgeGeo = new THREE.BoxGeometry(width + 2, 0.2, 0.5);
            const edgeMat = new THREE.MeshStandardMaterial({
                color: color,
                emissive: color,
                emissiveIntensity: 1.0,
                transparent: true,
                opacity: 0.8
            });
            
            const edges = [];
            const edgePositions = [
                [0, 0.3, depth/2], 
                [0, 0.3, -depth/2], 
                [width/2, 0.3, 0], 
                [-width/2, 0.3, 0]
            ];
            
            edgePositions.forEach(pos => {
                const edge = new THREE.Mesh(edgeGeo, edgeMat);
                edge.position.set(pos[0], pos[1], pos[2]);
                group.add(edge);
                edges.push(edge);
            });
            
            // –ù–ï–û–ù–û–í–´–ï –°–¢–û–õ–ë–´ –° –ö–û–õ–õ–ò–ó–ò–Ø–ú–ò
            const pillars = [];
            const pillarCount = type === 'item' ? 2 : Math.floor(Math.random() * 3) + 1;
            
            for (let i = 0; i < pillarCount; i++) {
                const pillarHeight = 2 + Math.random() * 4;
                const pillarGeo = new THREE.CylinderGeometry(0.3, 0.3, pillarHeight, 8);
                const pillarMat = new THREE.MeshStandardMaterial({
                    color: color,
                    emissive: color,
                    emissiveIntensity: 0.8
                });
                const pillar = new THREE.Mesh(pillarGeo, pillarMat);
                
                // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–æ–ª–±—ã –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ
                const angle = (i / pillarCount) * Math.PI * 2;
                const radius = (width / 2) - 1;
                pillar.position.set(
                    Math.cos(angle) * radius,
                    pillarHeight / 2,
                    Math.sin(angle) * radius
                );
                
                group.add(pillar);
                pillars.push({
                    mesh: pillar,
                    height: pillarHeight,
                    radius: 0.3
                });
            }
            
            // –î–û–ë–ê–í–õ–Ø–ï–ú –ü–†–ï–î–ú–ï–¢–´ –ù–ê –ü–õ–ê–¢–§–û–†–ú–´ –¢–ò–ü–ê 'item'
            let item = null;
            if (type === 'item') {
                const itemType = Math.random() > 0.5 ? 'stamina' : 'fuel';
                const itemColor = itemType === 'stamina' ? 0x00ff88 : 0xffaa00;
                
                const itemGeo = new THREE.SphereGeometry(0.5, 8, 8);
                const itemMat = new THREE.MeshStandardMaterial({
                    color: itemColor,
                    emissive: itemColor,
                    emissiveIntensity: 0.8,
                    transparent: true,
                    opacity: 0.9
                });
                
                item = new THREE.Mesh(itemGeo, itemMat);
                item.position.set(0, 3, 0);
                group.add(item);
                
                // –ê–Ω–∏–º–∞—Ü–∏—è –ø–∞—Ä—è—â–µ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞
                item.userData = {
                    type: itemType,
                    color: itemColor,
                    collected: false,
                    floatOffset: Math.random() * Math.PI * 2
                };
            }
            
            // –í—Ä–∞—â–∞—é—â–∏–µ—Å—è –≥–æ–ª–æ–≥—Ä–∞–º–º—ã –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º
            if (Math.random() > 0.7 && type !== 'narrow') {
                const hologramGeo = new THREE.CylinderGeometry(3, 3, 6, 8);
                const hologramMat = new THREE.MeshBasicMaterial({
                    color: color,
                    transparent: true,
                    opacity: 0.3,
                    wireframe: true
                });
                const hologram = new THREE.Mesh(hologramGeo, hologramMat);
                hologram.position.set(0, 4, 0);
                group.add(hologram);
                hologram.userData.rotate = true;
            }
            
            // –ê–ù–ò–ú–ê–¶–ò–ò –î–õ–Ø –°–ü–ï–¶–ò–ê–õ–¨–ù–´–• –ü–õ–ê–¢–§–û–†–ú
            if (type === 'moving') {
                group.userData.moveOffset = Math.random() * Math.PI * 2;
                group.userData.moveSpeed = 0.5 + Math.random() * 1;
                group.userData.moveDistance = 5 + Math.random() * 10;
                group.userData.moveAxis = Math.random() > 0.5 ? 'x' : 'z';
            }
            
            if (type === 'rotating') {
                group.userData.rotateSpeed = 0.5 + Math.random() * 1;
            }
            
            if (type === 'jump') {
                platformMat.emissiveIntensity = 0.8;
                platformMat.emissive.set(0xffff00);
            }
            
            group.position.set(x, y, z);
            group.userData = {
                hw: width/2,
                hh: 0.25,
                hd: depth/2,
                color: color,
                edges: edges,
                pillars: pillars,
                hologram: group.children.find(c => c.userData && c.userData.rotate),
                item: item,
                type: type,
                index: index
            };
            
            return group;
        }

        // –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
        function getPlatformPosition(index, isSpawn = false) {
            if (isSpawn) {
                return WORLD_CONFIG.SPAWN_PLATFORM_POSITION;
            }
            
            // –ë–ï–°–ö–û–ù–ï–ß–ù–ê–Ø –ì–ï–ù–ï–†–ê–¶–ò–Ø: –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–¥—É–ª—å –¥–ª—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
            const wrappedIndex = index % 1000; // –ü–æ–≤—Ç–æ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 1000 –ø–ª–∞—Ç—Ñ–æ—Ä–º
            
            const y = -index * WORLD_CONFIG.PLATFORM_SPACING;
            const z = -index * 25;
            
            // –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π RNG –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω–¥–µ–∫—Å–∞
            const seed = wrappedIndex * 9301 + 49297;
            const rand = (seed % 233280) / 233280;
            
            // –î–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è –∏–Ω–æ–≥–¥–∞ –¥–µ–ª–∞–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –≤—ã—à–µ/–Ω–∏–∂–µ
            const heightVariation = (Math.sin(wrappedIndex * 0.1) * 5);
            const finalY = y + heightVariation;
            
            // –ë–æ–ª–µ–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ X
            const x = (Math.sin(wrappedIndex * 0.05) * 40) + ((rand - 0.5) * 20);
            
            return { x, y: finalY, z };
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–ª–∏–∑–∏–π —Å —É—á–µ—Ç–æ–º —Å—Ç–æ–ª–±–æ–≤
        function checkCollision(pos) {
            const r = 0.5, h = 1.8;
            
            for (let p of platforms) {
                // –ö–æ–ª–ª–∏–∑–∏—è —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π
                if (pos.x > p.position.x - p.userData.hw - r && 
                    pos.x < p.position.x + p.userData.hw + r &&
                    pos.y > p.position.y - p.userData.hh - h && 
                    pos.y < p.position.y + p.userData.hh + 0.5 &&
                    pos.z > p.position.z - p.userData.hd - r && 
                    pos.z < p.position.z + p.userData.hd + r) {
                    return { collision: true, platform: p };
                }
                
                // –ö–æ–ª–ª–∏–∑–∏—è —Å–æ —Å—Ç–æ–ª–±–∞–º–∏ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ
                if (p.userData.pillars) {
                    for (let pillar of p.userData.pillars) {
                        const pillarPos = new THREE.Vector3(
                            pillar.mesh.position.x + p.position.x,
                            pillar.mesh.position.y + p.position.y,
                            pillar.mesh.position.z + p.position.z
                        );
                        
                        const dx = pos.x - pillarPos.x;
                        const dz = pos.z - pillarPos.z;
                        const distance = Math.sqrt(dx * dx + dz * dz);
                        
                        if (distance < pillar.radius + r && 
                            pos.y > pillarPos.y - pillar.height/2 && 
                            pos.y < pillarPos.y + pillar.height/2) {
                            return { collision: true, platform: p, pillar: true };
                        }
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
                if (p.userData.item && !p.userData.item.userData.collected) {
                    const itemPos = new THREE.Vector3(
                        p.userData.item.position.x + p.position.x,
                        p.userData.item.position.y + p.position.y,
                        p.userData.item.position.z + p.position.z
                    );
                    
                    const dx = pos.x - itemPos.x;
                    const dy = pos.y - itemPos.y;
                    const dz = pos.z - itemPos.z;
                    const distance = Math.sqrt(dx * dx + dy * dy + dz * dz);
                    
                    if (distance < 1.5) {
                        return { collision: false, platform: p, item: p.userData.item };
                    }
                }
            }
            
            return { collision: false };
        }

        // –≠—Ñ—Ñ–µ–∫—Ç —Å–±–æ—Ä–∞ –ø—Ä–µ–¥–º–µ—Ç–∞
        function collectItem(item, platform) {
            if (item.userData.collected) return;
            
            item.userData.collected = true;
            platform.remove(item);
            
            // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
            const pickupEffect = document.createElement('div');
            pickupEffect.className = 'item-pickup';
            pickupEffect.textContent = item.userData.type === 'stamina' ? '‚ö° +25%' : 'üõ¢Ô∏è +25%';
            pickupEffect.style.color = item.userData.type === 'stamina' ? '#00ff88' : '#ffaa00';
            pickupEffect.style.position = 'fixed';
            pickupEffect.style.left = '50%';
            pickupEffect.style.top = '50%';
            pickupEffect.style.transform = 'translate(-50%, -50%)';
            document.body.appendChild(pickupEffect);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            socket.emit('collectItem', item.userData.type);
            
            // –£–¥–∞–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
            setTimeout(() => {
                if (pickupEffect.parentNode) {
                    pickupEffect.parentNode.removeChild(pickupEffect);
                }
            }, 1000);
        }

        // --- –õ–û–ì–ò–ö–ê –ú–£–ó–´–ö–ò ---
        let playlist = [];
        let currentTrackIndex = 0;

        async function loadPlaylist() {
            try {
                const response = await fetch('/get-music');
                playlist = await response.json();
                renderPlaylist();
                if (playlist.length > 0) {
                    playTrack(0);
                }
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–µ–π–ª–∏—Å—Ç–∞:", e);
            }
        }

        function renderPlaylist() {
            musicListUI.innerHTML = "";
            playlist.forEach((track, index) => {
                const item = document.createElement('div');
                item.className = 'music-item' + (index === currentTrackIndex ? ' active' : '');
                item.innerHTML = `
                    <span>${track.replace('.mp3', '')}</span>
                    <span class="music-status">${index === currentTrackIndex ? '‚ñ∂ –ò–ì–†–ê–ï–¢' : '‚è∏ –ì–û–¢–û–í'}</span>
                `;
                item.onclick = () => playTrack(index);
                musicListUI.appendChild(item);
            });
        }

        function playTrack(index) {
            if (!playlist[index]) return;
            currentTrackIndex = index;
            bgMusic.src = playlist[index];
            bgMusic.play().catch(e => console.log("–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ"));
            
            trackNameUI.textContent = playlist[index].replace('.mp3', '');
            nowPlayingBox.style.display = 'block';
            renderPlaylist();
        }

        bgMusic.onended = () => {
            let next = (currentTrackIndex + 1) % playlist.length;
            playTrack(next);
        };

        bgMusic.volume = 0.35;
        volumeSlider.addEventListener('input', (e) => {
            bgMusic.volume = e.target.value;
        });

        // --- –†–ï–°–ü–ê–í–ù –ö–ù–û–ü–ö–ê ---
        function requestRespawn() {
            if (!isGaming) return;
            
            const now = Date.now();
            const timeLeft = Math.ceil((respawnCooldownEndTime - now) / 1000);
            
            if (respawnCooldown && timeLeft > 0) {
                const chatMessage = {
                    nick: '–°–ò–°–¢–ï–ú–ê',
                    msg: `–†–µ—Å–ø–∞–≤–Ω –Ω–∞ –∫—É–ª–¥–∞—É–Ω–µ: ${timeLeft} —Å–µ–∫.`,
                    type: 'sys'
                };
                socket.emit('receiveMessage', chatMessage);
                return;
            }
            
            console.log("–ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã —Ä–µ—Å–ø–∞–≤–Ω–∞...");
            
            socket.emit('requestRespawn');
            
            respawnCooldown = true;
            respawnCooldownEndTime = now + 3000;
            respawnBtn.disabled = true;
            respawnBtn.textContent = 'üîÑ –ö–£–õ–î–ê–£–ù (3—Å)';
            
            setTimeout(() => {
                showRespawnModal();
            }, 1000);
        }

        respawnBtn.addEventListener('click', () => {
            requestRespawn();
        });

        // –°–æ–±—ã—Ç–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –æ –∫–æ–Ω—Ü–µ –∫—É–ª–¥–∞—É–Ω–∞
        socket.on('respawnCooldownEnd', () => {
            console.log("–ö—É–ª–¥–∞—É–Ω —Ä–µ—Å–ø–∞–≤–Ω–∞ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è");
            respawnCooldown = false;
            respawnBtn.disabled = false;
            respawnBtn.textContent = 'üîÑ –†–ï–°–ü–ê–í–ù';
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—É–ª–¥–∞—É–Ω–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        function updateRespawnCooldown() {
            if (respawnCooldown && respawnCooldownEndTime) {
                const now = Date.now();
                const timeLeft = Math.ceil((respawnCooldownEndTime - now) / 1000);
                
                if (timeLeft > 0) {
                    respawnBtn.textContent = `üîÑ –ö–£–õ–î–ê–£–ù (${timeLeft}—Å)`;
                } else {
                    respawnCooldown = false;
                    respawnBtn.disabled = false;
                    respawnBtn.textContent = 'üîÑ –†–ï–°–ü–ê–í–ù';
                }
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        settingsBtn.addEventListener('click', () => {
            if (!isGaming) return;
            
            const isShown = settingsMenu.style.display === 'block';
            settingsMenu.style.display = isShown ? 'none' : 'block';
            if (!isShown) {
                document.exitPointerLock();
            } else {
                if (isGaming) requestLock();
            }
        });

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        applySettings.addEventListener('click', applyGraphicsSettings);

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–£–†–°–û–†–û–ú ---
        function requestLock() {
            if (isGaming && document.activeElement !== chatInput) {
                document.body.requestPointerLock();
            }
        }
        lockBtn.addEventListener('click', (e) => { e.stopPropagation(); requestLock(); });

        document.addEventListener('keydown', (e) => {
            if (e.code === 'Escape') {
                document.exitPointerLock();
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –º–µ–Ω—é
                if (musicMenu.style.display === 'block') musicMenu.style.display = 'none';
                if (settingsMenu.style.display === 'block') settingsMenu.style.display = 'none';
                if (document.getElementById('tab-menu').style.display === 'block') {
                    document.getElementById('tab-menu').style.display = 'none';
                }
            }
        });

        // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–ê–î–ï–ù–ò–Ø –ü–†–ò –ê–ö–¢–ò–í–ù–û–ú –ß–ê–¢–ï ---
        let wasInChat = false;
        let chatEnterVelocity = 0;

        // --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ì–û–õ–û–°–û–í–û–ô –ß–ê–¢ ---
        let audioCtx;
        let mediaStream = null;
        let mediaSource = null;
        let audioProcessor = null;
        let audioInterval = null;
        
        const SAMPLE_RATE = 22050;
        
        async function initVoice() {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext({ sampleRate: SAMPLE_RATE });

                mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: SAMPLE_RATE,
                        channelCount: 1,
                        latency: 0.01
                    }
                });
                
                mediaSource = audioCtx.createMediaStreamSource(mediaStream);
                audioProcessor = audioCtx.createScriptProcessor(1024, 1, 1);
                
                mediaSource.connect(audioProcessor);
                audioProcessor.connect(audioCtx.destination);
                
                audioProcessor.onaudioprocess = (e) => {
                    if (keys.v && document.activeElement !== chatInput && isGaming) {
                        const input = e.inputBuffer.getChannelData(0);
                        const output = new Int8Array(input.length);
                        for (let i = 0; i < input.length; i++) {
                            output[i] = Math.max(-1, Math.min(1, input[i])) * 0x7F;
                        }
                        socket.volatile.emit('audioStream', output.buffer);
                    }
                };
                
                if (audioInterval) clearInterval(audioInterval);
                audioInterval = setInterval(() => {
                    if (keys.v && isGaming) {
                        socket.volatile.emit('audioHeartbeat');
                    }
                }, 50);
                
            } catch(e) { 
                console.log("–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:", e); 
            }
        }

        function initAudioPlayer(playerId) {
            if (audioPlayers[playerId]) {
                return audioPlayers[playerId];
            }
            
            const audioPlayer = {
                nextTime: 0,
                gainNode: null,
                lastUpdate: Date.now(),
                audioQueue: [],
                isPlaying: false
            };
            
            audioPlayers[playerId] = audioPlayer;
            return audioPlayer;
        }

        socket.on('audioStream', (data) => {
            if (!isGaming || !otherPlayers[data.id] || !audioCtx) return;
            
            const dist = cameraHolder.position.distanceTo(new THREE.Vector3(data.pos.x, data.pos.y, data.pos.z));
            if (dist > 60) return;
            
            const vol = Math.max(0.01, 1 - (dist / 60));
            
            if (!audioPlayers[data.id]) {
                initAudioPlayer(data.id);
            }
            
            const player = audioPlayers[data.id];
            player.lastUpdate = Date.now();
            
            try {
                const intData = new Int8Array(data.buffer);
                const floatData = new Float32Array(intData.length);
                for (let i = 0; i < intData.length; i++) {
                    floatData[i] = intData[i] / 0x7F;
                }
                
                const buffer = audioCtx.createBuffer(1, floatData.length, SAMPLE_RATE);
                buffer.copyToChannel(floatData, 0);
                
                player.audioQueue.push({buffer: buffer, volume: vol});
                
                if (!player.isPlaying) {
                    processAudioQueue(player);
                }
                
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
                
            } catch(e) {
                console.error("–û—à–∏–±–∫–∞ –∞—É–¥–∏–æ:", e);
            }
        });

        function processAudioQueue(player) {
            if (player.audioQueue.length === 0) {
                player.isPlaying = false;
                return;
            }
            
            player.isPlaying = true;
            const audioData = player.audioQueue.shift();
            
            const source = audioCtx.createBufferSource();
            source.buffer = audioData.buffer;
            
            if (!player.gainNode) {
                player.gainNode = audioCtx.createGain();
                player.gainNode.connect(audioCtx.destination);
            }
            source.connect(player.gainNode);
            player.gainNode.gain.value = audioData.volume;

            source.start(0);
            
            source.onended = () => {
                setTimeout(() => processAudioQueue(player), 0);
            };
        }

        setInterval(() => {
            const now = Date.now();
            for (const playerId in audioPlayers) {
                if (now - audioPlayers[playerId].lastUpdate > 3000) {
                    if (audioPlayers[playerId].gainNode) {
                        audioPlayers[playerId].gainNode.disconnect();
                    }
                    delete audioPlayers[playerId];
                }
            }
        }, 2000);

        // --- –°–û–ë–´–¢–ò–Ø –°–ï–¢–ò ---
        socket.on('worldConfig', (config) => {
            WORLD_CONFIG = config;
            console.log("–ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–∏—Ä–∞:", WORLD_CONFIG);
        });

        socket.on('updateDistance', (distance) => {
            distanceTraveled = distance;
            distanceValue.textContent = `${distance} –º`;
            
            // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏
            if (distance >= 1000) {
                distanceCounter.style.borderColor = 'var(--orange)';
                distanceCounter.style.color = 'var(--orange)';
                distanceCounter.style.boxShadow = '0 0 20px rgba(255, 170, 0, 0.3)';
            } else if (distance >= 500) {
                distanceCounter.style.borderColor = 'var(--green)';
                distanceCounter.style.color = 'var(--green)';
                distanceCounter.style.boxShadow = '0 0 20px rgba(0, 255, 136, 0.3)';
            } else {
                distanceCounter.style.borderColor = 'var(--purple)';
                distanceCounter.style.color = 'var(--purple)';
                distanceCounter.style.boxShadow = '0 0 20px rgba(157, 0, 255, 0.3)';
            }
        });

        socket.on('playerStats', (stats) => {
            staminaMax = stats.maxStamina;
            fuelMax = stats.maxFuel;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–æ—Å–∫–∏ –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–µ–≤—ã—à–∞—é—Ç –Ω–æ–≤—ã–µ –º–∞–∫—Å–∏–º—É–º—ã
            if (stamina > staminaMax) stamina = staminaMax;
            if (jetpackFuel > fuelMax) jetpackFuel = fuelMax;
        });

        socket.on('teleport', (p) => { 
            console.log("–¢–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏—è –Ω–∞:", p);
            
            cameraHolder.position.set(p.x, p.y, p.z); 
            velY = 0; 
            jetpackFuel = fuelMax;
            
            socket.emit('move', {
                x: p.x, 
                y: p.y, 
                z: p.z, 
                nick: myNick
            });
            
            const div = document.createElement('div');
            div.className = 'msg-line';
            const b = document.createElement('b');
            b.textContent = '–°–ò–°–¢–ï–ú–ê: ';
            b.style.color = 'var(--sys)';
            const span = document.createElement('span');
            span.textContent = `–¢–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏—è –Ω–∞ X=${p.x.toFixed(1)}, Y=${p.y.toFixed(1)}, Z=${p.z.toFixed(1)}`;
            div.appendChild(b);
            div.appendChild(span);
            const m = document.getElementById('chat-messages');
            m.appendChild(div); 
            m.scrollTop = m.scrollHeight;
        });
        
        socket.on('setFly', s => { 
            isAdminFly = s; 
            velY = 0; 
            flyUI.style.display = s ? 'block' : 'none'; 
        });
        
        socket.on('forceKill', () => { 
            cameraHolder.position.set(
                WORLD_CONFIG.SPAWN_POSITION.x, 
                WORLD_CONFIG.SPAWN_POSITION.y, 
                WORLD_CONFIG.SPAWN_POSITION.z
            ); 
            velY = 0; 
            jetpackFuel = fuelMax;
            socket.emit('move', {
                x: WORLD_CONFIG.SPAWN_POSITION.x, 
                y: WORLD_CONFIG.SPAWN_POSITION.y, 
                z: WORLD_CONFIG.SPAWN_POSITION.z, 
                nick: myNick
            });
        });

        // --- –ì–†–ê–§–ò–ö–ê ---
        const scene = new THREE.Scene(); 
        scene.fog = new THREE.FogExp2(0x000011, 0.008);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 2000);
        const cameraHolder = new THREE.Group(); 
        cameraHolder.add(camera); 
        scene.add(cameraHolder);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight); 
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        loadSettings();

        // –ù–µ–æ–Ω–æ–≤–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ
        const ambientLight = new THREE.AmbientLight(0x222222);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0x00aaff, 0.5);
        directionalLight.position.set(10, 20, 5);
        directionalLight.castShadow = true;
        directionalLight.shadow.camera.left = -50;
        directionalLight.shadow.camera.right = 50;
        directionalLight.shadow.camera.top = 50;
        directionalLight.shadow.camera.bottom = -50;
        scene.add(directionalLight);
        
        const pointLight = new THREE.PointLight(0xff00ff, 0.5, 100);
        pointLight.position.set(0, 10, 0);
        scene.add(pointLight);

        // –ó–≤–µ–∑–¥—ã
        let stars;
        
        function initStars() {
            if (stars) scene.remove(stars);
            stars = createStars(graphicsSettings.stars);
            scene.add(stars);
        }
        
        initStars();

        // –°–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
        function createPlayer(id, nick) {
            const group = new THREE.Group();
            
            const bodyGeo = new THREE.CylinderGeometry(0.4, 0.6, 2, 8);
            const bodyMat = new THREE.MeshStandardMaterial({
                color: 0x00ff88,
                emissive: 0x00ff88,
                emissiveIntensity: 0.3,
                metalness: 0.8,
                roughness: 0.2
            });
            const body = new THREE.Mesh(bodyGeo, bodyMat);
            body.position.y = 1;
            group.add(body);
            
            const headGeo = new THREE.SphereGeometry(0.3, 8, 8);
            const headMat = new THREE.MeshStandardMaterial({
                color: 0x00ff88,
                emissive: 0x00ff88,
                emissiveIntensity: 0.2
            });
            const head = new THREE.Mesh(headGeo, headMat);
            head.position.y = 2.2;
            group.add(head);
            
            const jetpackGeo = new THREE.BoxGeometry(0.6, 1.2, 0.4);
            const jetpackMat = new THREE.MeshStandardMaterial({
                color: 0x333333,
                metalness: 0.9,
                roughness: 0.1
            });
            const jetpack = new THREE.Mesh(jetpackGeo, jetpackMat);
            jetpack.position.set(0, 0.6, 0.3);
            group.add(jetpack);
            
            const neonGeo = new THREE.BoxGeometry(0.2, 0.4, 0.1);
            const neonMat = new THREE.MeshBasicMaterial({
                color: 0x00d9ff,
                transparent: true,
                opacity: 0.8
            });
            const neonLeft = new THREE.Mesh(neonGeo, neonMat);
            neonLeft.position.set(0.2, 0.4, 0.35);
            group.add(neonLeft);
            
            const neonRight = new THREE.Mesh(neonGeo, neonMat);
            neonRight.position.set(-0.2, 0.4, 0.35);
            group.add(neonRight);
            
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#00d9ff';
            ctx.font = 'bold 36px "Courier New", monospace';
            ctx.textAlign = 'center';
            ctx.fillText(nick, 256, 60);
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 3;
            ctx.strokeText(nick, 256, 60);
            
            const spriteMat = new THREE.SpriteMaterial({ 
                map: new THREE.CanvasTexture(canvas),
                transparent: true
            });
            const sprite = new THREE.Sprite(spriteMat);
            sprite.position.y = 2.8;
            sprite.scale.set(5, 1.25, 1);
            group.add(sprite);
            
            scene.add(group);
            return { 
                mesh: group, 
                targetPos: new THREE.Vector3(),
                nickSprite: sprite
            };
        }

        // –°–µ—Ç–µ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤
        socket.on('currentPlayers', ps => {
            const list = document.getElementById('tab-list'); 
            list.innerHTML = ""; 
            Object.keys(ps).forEach(id => {
                const row = document.createElement('div'); 
                row.className = 'tab-row';
                row.id = `row-${id}`;
                row.textContent = ps[id].nick;
                const status = document.createElement('span');
                status.style.color = 'var(--green)';
                status.textContent = ' ‚óè –û–ù–õ–ê–ô–ù';
                row.appendChild(status);
                list.appendChild(row);

                if (id !== socket.id && !otherPlayers[id]) {
                    otherPlayers[id] = createPlayer(id, ps[id].nick);
                    initAudioPlayer(id);
                }
            });
        });

        socket.on('playerMoved', d => { 
            if(otherPlayers[d.id]) {
                otherPlayers[d.id].targetPos.set(d.x, d.y, d.z);
            }
        });
        
        socket.on('playerLeft', id => { 
            if(otherPlayers[id]) { 
                scene.remove(otherPlayers[id].mesh); 
                delete otherPlayers[id]; 
            }
            if (audioPlayers[id]) {
                if (audioPlayers[id].gainNode) {
                    audioPlayers[id].gainNode.disconnect();
                }
                delete audioPlayers[id];
            }
            const row = document.getElementById(`row-${id}`); 
            if (row) row.remove();
        });

        // --- –ë–ï–°–ö–û–ù–ï–ß–ù–ê–Ø –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ê–Ø –ì–ï–ù–ï–†–ê–¶–ò–Ø –ú–ò–†–ê ---
        function generateInitialWorld() {
            platforms.forEach(p => {
                scene.remove(p);
            });
            platforms = [];
            
            const spawnPos = WORLD_CONFIG.SPAWN_PLATFORM_POSITION;
            console.log("–°–æ–∑–¥–∞–µ–º —Å–ø–∞–≤–Ω –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –Ω–∞:", spawnPos);
            
            const startPlatform = createCyberPlatform(spawnPos.x, spawnPos.y, spawnPos.z, 'spawn', 0);
            scene.add(startPlatform);
            platforms.push(startPlatform);
            
            generateWorldAroundPlayer();
            
            createParticles();
            
            worldGenerated = true;
            lastGeneratedIndex = 0;
            
            console.log("–ú–∏—Ä —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω. –ë–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞.");
        }

        function generateWorldAroundPlayer() {
            const playerY = cameraHolder.position.y;
            const targetIndex = Math.floor(Math.abs(playerY - WORLD_CONFIG.GENERATION_DISTANCE) / WORLD_CONFIG.PLATFORM_SPACING);
            
            // –ë–ï–°–ö–û–ù–ï–ß–ù–ê–Ø –ì–ï–ù–ï–†–ê–¶–ò–Ø: –≤—Å–µ–≥–¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º, –µ—Å–ª–∏ –∏–≥—Ä–æ–∫ —É—à–µ–ª –¥–∞–ª—å—à–µ
            if (targetIndex <= lastGeneratedIndex) {
                return;
            }
            
            const platformsToGenerate = Math.min(targetIndex - lastGeneratedIndex, 50);
            
            for (let i = 0; i < platformsToGenerate && lastGeneratedIndex + i < 10000; i++) {
                const index = lastGeneratedIndex + i;
                const pos = getPlatformPosition(index);
                const type = getPlatformType(index);
                
                const platform = createCyberPlatform(pos.x, pos.y, pos.z, type, index);
                scene.add(platform);
                platforms.push(platform);
                
                // –°–æ–∑–¥–∞–µ–º –º–æ—Å—Ç–∏–∫–∏ –º–µ–∂–¥—É –Ω–µ–∫–æ—Ç–æ—Ä—ã–º–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º–∏
                if (Math.random() > 0.8 && index > 5 && type !== 'narrow') {
                    const bridgePos = {
                        x: pos.x,
                        y: pos.y + 6,
                        z: pos.z - 12.5
                    };
                    const bridge = createCyberPlatform(bridgePos.x, bridgePos.y, bridgePos.z, 'normal', index + 1000);
                    scene.add(bridge);
                    platforms.push(bridge);
                }
            }
            
            lastGeneratedIndex += platformsToGenerate;
            
            // –û—á–∏—â–∞–µ–º —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
            cleanupDistantPlatforms(playerY);
        }

        function cleanupDistantPlatforms(playerY) {
            const MAX_DISTANCE = 400;
            
            for (let i = platforms.length - 1; i >= 0; i--) {
                const platform = platforms[i];
                const distance = Math.abs(platform.position.y - playerY);
                
                if (distance > MAX_DISTANCE) {
                    scene.remove(platform);
                    platforms.splice(i, 1);
                }
            }
        }

        function createParticles() {
            if (particlesSystem) {
                scene.remove(particlesSystem);
            }
            
            if (!graphicsSettings.particles) return;
            
            const particleCount = 500;
            const particleGeometry = new THREE.BufferGeometry();
            const particlePositions = new Float32Array(particleCount * 3);
            const particleColors = new Float32Array(particleCount * 3);
            
            for (let i = 0; i < particleCount; i++) {
                particlePositions[i * 3] = (Math.random() - 0.5) * 800;
                particlePositions[i * 3 + 1] = (Math.random() - 0.5) * 800 - 200;
                particlePositions[i * 3 + 2] = (Math.random() - 0.5) * 800 - 400;
                
                const color = new THREE.Color(
                    Math.random() > 0.5 ? 0x00d9ff : 0xff00ff
                );
                particleColors[i * 3] = color.r;
                particleColors[i * 3 + 1] = color.g;
                particleColors[i * 3 + 2] = color.b;
            }
            
            particleGeometry.setAttribute('position', new THREE.BufferAttribute(particlePositions, 3));
            particleGeometry.setAttribute('color', new THREE.BufferAttribute(particleColors, 3));
            
            const particleMaterial = new THREE.PointsMaterial({
                size: 0.5,
                vertexColors: true,
                transparent: true,
                opacity: 0.6
            });
            
            particlesSystem = new THREE.Points(particleGeometry, particleMaterial);
            scene.add(particlesSystem);
        }

        // --- INPUT ---
        let keys = {w:0,s:0,a:0,d:0,shift:0,v:0,space:0,ctrl:0};
        let velY = 0, jumpCount = 0, pitch = 0, yaw = 0;

        window.addEventListener('keydown', e => {
            if(document.activeElement === chatInput) {
                if(e.code === 'Enter') {
                    if(chatInput.value.trim()) socket.emit('chatMessage', chatInput.value);
                    chatInput.value = ""; 
                    
                    wasInChat = false;
                    chatInput.blur(); 
                    if (isGaming) requestLock();
                }
                if(e.code === 'Escape') {
                    wasInChat = false;
                    chatInput.blur();
                    if (isGaming) requestLock();
                }
                return;
            }
            
            if(e.code === 'Tab') { 
                if (isGaming) {
                    e.preventDefault(); 
                    document.getElementById('tab-menu').style.display='block'; 
                }
                return; 
            }
            
            if(e.code === 'KeyP') {
                if (!isGaming) return;
                const isShown = musicMenu.style.display === 'block';
                musicMenu.style.display = isShown ? 'none' : 'block';
                if (!isShown) document.exitPointerLock();
                else requestLock();
                return;
            }

            if(e.code === 'Enter') {
                wasInChat = true;
                chatEnterVelocity = velY;
                
                chatInput.focus(); 
                document.exitPointerLock(); 
                return;
            }
            
            if(e.code === 'KeyV') { 
                keys.v = 1; 
                voiceUI.style.display='block'; 
            }
            if(e.code === 'KeyW') keys.w=1; 
            if(e.code === 'KeyS') keys.s=1;
            if(e.code === 'KeyA') keys.a=1; 
            if(e.code === 'KeyD') keys.d=1;
            
            // –§–ò–ö–°: –ó–∞—â–∏—Ç–∞ –æ—Ç –±—ã—Å—Ç—Ä–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è –ø—Ä–æ–±–µ–ª–∞
            if(e.code === 'Space') {
                const now = Date.now();
                if (now - spacePressTime > SPACE_COOLDOWN) {
                    keys.space = 1;
                    spacePressTime = now;
                }
            }
            
            if(e.code === 'ControlLeft') keys.ctrl=1;
            if(e.shiftKey) keys.shift=1;
        });

        window.addEventListener('keyup', e => {
            if(e.code === 'Tab' && isGaming) document.getElementById('tab-menu').style.display='none';
            if(e.code === 'KeyV') { 
                keys.v = 0; 
                voiceUI.style.display='none'; 
            }
            if(e.code === 'KeyW') keys.w=0; 
            if(e.code === 'KeyS') keys.s=0;
            if(e.code === 'KeyA') keys.a=0; 
            if(e.code === 'KeyD') keys.d=0;
            if(e.code === 'Space') keys.space=0;
            if(e.code === 'ControlLeft') keys.ctrl=0;
            if(!e.shiftKey) keys.shift=0;
        });

        document.addEventListener('mousemove', e => { 
            if(document.pointerLockElement){ 
                yaw -= e.movementX * 0.002; 
                pitch = Math.max(-1.4, Math.min(1.4, pitch - e.movementY * 0.002)); 
            } 
        });

        // --- –°–¢–ê–†–¢ –ò–ì–†–´ ---
        document.getElementById('startBtn').onclick = () => {
            myNick = document.getElementById('nickInput').value.trim() || "–ù–û–í–´–ô";
            if (!myNick || myNick.length === 0) {
                myNick = "–ù–û–í–´–ô";
            }
            
            cameraHolder.position.set(
                WORLD_CONFIG.SPAWN_POSITION.x,
                WORLD_CONFIG.SPAWN_POSITION.y,
                WORLD_CONFIG.SPAWN_POSITION.z
            );
            velY = 0;
            jetpackFuel = fuelMax;
            distanceTraveled = 0;
            distanceValue.textContent = "0 –º";
            
            socket.emit('initPlayer', myNick);
            menu.style.display = 'none';
            madeBy.style.display = 'block';
            volumeContainer.style.display = 'flex'; 
            fpsCounter.style.display = 'block';
            respawnBtn.style.display = 'flex';
            settingsBtn.style.display = 'flex';
            distanceCounter.style.display = 'flex';
            
            isGaming = true; 
            requestLock(); 
            initVoice();
            loadPlaylist();
            
            setTimeout(() => {
                generateInitialWorld();
            }, 100);

            if(!audioCtx) {
                 const AudioContext = window.AudioContext || window.webkitAudioContext;
                 audioCtx = new AudioContext({ sampleRate: SAMPLE_RATE });
            }
            if(audioCtx.state === 'suspended') audioCtx.resume();
            
            console.log("–ò–≥—Ä–∞ –Ω–∞—á–∞—Ç–∞. –ü–æ–∑–∏—Ü–∏—è –∏–≥—Ä–æ–∫–∞:", cameraHolder.position);
        };

        document.getElementById('nickInput').focus();

        // --- –ê–ù–ò–ú–ê–¶–ò–Ø ---
        function updateFPS() {
            frameCount++;
            const currentTime = performance.now();
            if (currentTime >= lastTime + 1000) {
                fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
                frameCount = 0;
                lastTime = currentTime;
                fpsCounter.textContent = `FPS: ${fps}`;
                
                // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç FPS –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–Ω–∞—á–µ–Ω–∏—è
                if (fps < 30) {
                    fpsCounter.style.color = 'var(--red)';
                    fpsCounter.style.borderColor = 'var(--red)';
                } else if (fps < 50) {
                    fpsCounter.style.color = 'var(--orange)';
                    fpsCounter.style.borderColor = 'var(--orange)';
                } else {
                    fpsCounter.style.color = 'var(--green)';
                    fpsCounter.style.borderColor = 'var(--green)';
                }
            }
        }

        function animate(currentTime) {
            requestAnimationFrame(animate);
            
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ FPS
            if (targetFPS > 0) {
                const deltaTime = currentTime - lastFrameTime;
                const targetDelta = 1000 / targetFPS;
                
                if (deltaTime < targetDelta) {
                    return;
                }
                lastFrameTime = currentTime - (deltaTime % targetDelta);
            } else {
                lastFrameTime = currentTime;
            }
            
            updateFPS();
            
            if(!isGaming) return;

            const dt = Math.min(clock.getDelta(), 0.1);
            const fpsMult = dt * 60;

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫—É–ª–¥–∞—É–Ω —Ä–µ—Å–ø–∞–≤–Ω–∞
            updateRespawnCooldown();

            // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏—Ä–∞ (–ë–ï–°–ö–û–ù–ï–ß–ù–ê–Ø)
            if (worldGenerated) {
                generateWorldAroundPlayer();
            }

            const isMoving = keys.w || keys.s || keys.a || keys.d;
            const wantsToSprint = keys.shift;
            
            isSprinting = wantsToSprint && isMoving && stamina > 0 && canSprint;
            
            if (isSprinting) {
                stamina = Math.max(0, stamina - 0.8 * fpsMult);
                if (stamina <= 0) {
                    canSprint = false;
                    sprintCooldown = true;
                    setTimeout(() => {
                        canSprint = true;
                        sprintCooldown = false;
                    }, 3000);
                }
            } else {
                if (stamina < staminaMax && !sprintCooldown) {
                    stamina = Math.min(staminaMax, stamina + 0.4 * fpsMult);
                    if (stamina >= 30 && !canSprint) {
                        canSprint = true;
                    }
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–æ—Å–∫–∏ —Å —É—á–µ—Ç–æ–º –Ω–æ–≤—ã—Ö –º–∞–∫—Å–∏–º—É–º–æ–≤
            document.getElementById('stamina-bar').style.width = (stamina / staminaMax * 100) + "%";
            document.getElementById('fuel-bar').style.width = (jetpackFuel / fuelMax * 100) + "%";

            const staminaBar = document.getElementById('stamina-bar');
            if (stamina <= 20) {
                staminaBar.style.background = 'linear-gradient(90deg, var(--orange), var(--pink))';
                staminaBar.style.boxShadow = '0 0 10px var(--orange-glow)';
            } else if (stamina <= 50) {
                staminaBar.style.background = 'linear-gradient(90deg, var(--yellow), var(--orange))';
                staminaBar.style.boxShadow = '0 0 10px var(--yellow-glow)';
            } else {
                staminaBar.style.background = 'linear-gradient(90deg, var(--green), var(--neon))';
                staminaBar.style.boxShadow = '0 0 10px var(--green-glow)';
            }

            cameraHolder.rotation.y = yaw; 
            camera.rotation.x = pitch;

            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º
            platforms.forEach(p => {
                // –ê–Ω–∏–º–∞—Ü–∏—è –¥–≤–∏–∂—É—â–∏—Ö—Å—è –ø–ª–∞—Ç—Ñ–æ—Ä–º
                if (p.userData.type === 'moving' && p.userData.moveOffset !== undefined) {
                    const time = Date.now() * 0.001;
                    const offset = Math.sin(time * p.userData.moveSpeed + p.userData.moveOffset) * p.userData.moveDistance;
                    
                    if (p.userData.moveAxis === 'x') {
                        p.position.x = p.userData.originalX + offset;
                    } else {
                        p.position.z = p.userData.originalZ + offset;
                    }
                }
                
                // –ê–Ω–∏–º–∞—Ü–∏—è –≤—Ä–∞—â–∞—é—â–∏—Ö—Å—è –ø–ª–∞—Ç—Ñ–æ—Ä–º
                if (p.userData.type === 'rotating' && p.userData.rotateSpeed) {
                    p.rotation.y += p.userData.rotateSpeed * dt;
                }
                
                // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–µ–¥–º–µ—Ç–æ–≤
                if (p.userData.item && !p.userData.item.userData.collected) {
                    const time = Date.now() * 0.001;
                    p.userData.item.position.y = 3 + Math.sin(time + p.userData.item.userData.floatOffset) * 0.5;
                    p.userData.item.rotation.y += 0.02;
                }
                
                // –ê–Ω–∏–º–∞—Ü–∏—è –≥–æ–ª–æ–≥—Ä–∞–º–º
                if (p.userData.hologram) {
                    p.userData.hologram.rotation.y += 0.01;
                }
                
                // –ê–Ω–∏–º–∞—Ü–∏—è –Ω–µ–æ–Ω–æ–≤—ã—Ö –ø–æ–ª–æ—Å
                if (p.userData.edges) {
                    p.userData.edges.forEach(edge => {
                        edge.material.emissiveIntensity = 0.5 + Math.sin(Date.now() * 0.002) * 0.5;
                    });
                }
            });

            // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω —á–∞—Ç, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–∑–∏–∫—É
            if(document.activeElement === chatInput) {
                // –ù–µ –æ–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–∑–∏–∫—É –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º —á–∞—Ç–µ
            } else if (musicMenu.style.display !== 'block' && settingsMenu.style.display !== 'block') {
                let moveVector = new THREE.Vector3();
                let baseSpeed;
                if (isSprinting && canSprint) {
                    baseSpeed = 0.6;
                } else if (!canSprint || stamina <= 0) {
                    baseSpeed = 0.25;
                } else {
                    baseSpeed = 0.3;
                }
                
                let moveSpeed = baseSpeed * fpsMult;

                if(isAdminFly) {
                    const dir = new THREE.Vector3(); 
                    camera.getWorldDirection(dir);
                    const side = new THREE.Vector3().crossVectors(camera.up, dir).normalize();
                    
                    if(keys.w) moveVector.addScaledVector(dir, moveSpeed);
                    if(keys.s) moveVector.addScaledVector(dir, -moveSpeed);
                    if(keys.a) moveVector.addScaledVector(side, moveSpeed);
                    if(keys.d) moveVector.addScaledVector(side, -moveSpeed);
                    if(keys.space) moveVector.y += moveSpeed;
                    if(keys.ctrl) moveVector.y -= moveSpeed;
                    
                    let nextPos = cameraHolder.position.clone().add(moveVector);
                    const collision = checkCollision(nextPos);
                    if (!collision.collision) {
                        cameraHolder.position.copy(nextPos);
                    }
                } else {
                    const forward = new THREE.Vector3(0, 0, -1).applyAxisAngle(new THREE.Vector3(0, 1, 0), yaw);
                    const right = new THREE.Vector3(1, 0, 0).applyAxisAngle(new THREE.Vector3(0, 1, 0), yaw);

                    if(keys.w) moveVector.addScaledVector(forward, moveSpeed);
                    if(keys.s) moveVector.addScaledVector(forward, -moveSpeed);
                    if(keys.d) moveVector.addScaledVector(right, moveSpeed);
                    if(keys.a) moveVector.addScaledVector(right, -moveSpeed);

                    let nextPos = cameraHolder.position.clone().add(moveVector);
                    const collision = checkCollision(new THREE.Vector3(nextPos.x, cameraHolder.position.y, nextPos.z));
                    
                    if(!collision.collision) {
                        cameraHolder.position.x = nextPos.x;
                        cameraHolder.position.z = nextPos.z;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–±–æ—Ä –ø—Ä–µ–¥–º–µ—Ç–æ–≤
                    if (collision.item) {
                        collectItem(collision.item, collision.platform);
                    }
                    
                    let gravity = 0.012 * fpsMult;
                    let jumpForce = 0.32;
                    let jetForce = 0.04 * fpsMult;

                    // –§–ò–ö–°: –ó–∞—â–∏—Ç–∞ –æ—Ç –±—ã—Å—Ç—Ä–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è –ø—Ä–æ–±–µ–ª–∞
                    const now = Date.now();
                    const canUseSpace = (now - spacePressTime) > SPACE_COOLDOWN || keys.space === 1;
                    
                    if (keys.space && canUseSpace && jetpackFuel > 0) {
                        if (jumpCount < 2 && velY <= 0.1 && velY >= -0.1) {
                            velY = jumpForce; 
                            jumpCount++;
                            spacePressTime = now;
                        } else {
                            velY = Math.min(velY + jetForce, 0.4); 
                            jetpackFuel = Math.max(0, jetpackFuel - 0.8 * fpsMult); 
                        }
                    } else {
                        velY -= gravity;
                    }

                    let nextY = cameraHolder.position.y + (velY * fpsMult);
                    let onGround = false;

                    platforms.forEach(p => {
                        if(Math.abs(cameraHolder.position.x - p.position.x) < p.userData.hw+0.6 && 
                           Math.abs(cameraHolder.position.z - p.position.z) < p.userData.hd+0.6) {
                            if(cameraHolder.position.y >= p.position.y-1 && nextY <= p.position.y+p.userData.hh+1.8 && velY <= 0) {
                                velY=0; 
                                nextY = p.position.y+p.userData.hh+1.7; 
                                jumpCount=0; 
                                onGround = true;
                            }
                            else if (cameraHolder.position.y < p.position.y-p.userData.hh && nextY > p.position.y-p.userData.hh-0.5 && velY > 0) {
                                velY = -0.05; 
                                nextY = cameraHolder.position.y;
                            }
                        }
                    });

                    if (onGround) jetpackFuel = Math.min(fuelMax, jetpackFuel + 0.5 * fpsMult);
                    cameraHolder.position.y = nextY;
                }
            }
            
            // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ —á—Ç–æ –≤—ã—à–ª–∏ –∏–∑ —á–∞—Ç–∞, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–∑–∏–∫—É
            if (wasInChat && document.activeElement !== chatInput) {
                velY = chatEnterVelocity;
                wasInChat = false;
            }
            
            // –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –ø–æ–∑–∏—Ü–∏–π –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
            for(let id in otherPlayers) {
                otherPlayers[id].mesh.position.lerp(otherPlayers[id].targetPos, 0.2 * fpsMult);
                if (otherPlayers[id].nickSprite) {
                    otherPlayers[id].nickSprite.lookAt(camera.position);
                }
            }
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –∑–≤–µ–∑–¥
            if (stars) {
                stars.rotation.y += 0.00005;
            }

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            socket.emit('move', {
                x: cameraHolder.position.x, 
                y: cameraHolder.position.y, 
                z: cameraHolder.position.z, 
                nick: myNick
            });
            
            renderer.render(scene, camera);
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
        requestAnimationFrame(animate);

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞
        socket.on('receiveMessage', d => {
            const div = document.createElement('div');
            div.className = 'msg-line';
            const b = document.createElement('b');
            b.textContent = d.nick + ": ";
            if (d.type === 'sys') b.style.color = 'var(--sys)';
            else if (d.nick === '–°–ï–†–í–ï–†') b.style.color = '#ff4444';
            else if (d.nick === myNick) b.style.color = 'var(--green)';
            else b.style.color = 'var(--neon)';
            const span = document.createElement('span');
            span.textContent = d.msg;
            div.appendChild(b);
            div.appendChild(span);
            const m = document.getElementById('chat-messages');
            m.appendChild(div); 
            m.scrollTop = m.scrollHeight;
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            initStars();
        });
    </script>
</body>
</html>
